# 群聊功能测试指南

## 🎯 功能概述

本文档提供了完整的群聊功能测试流程，确保所有功能正常工作。

## 📋 测试前准备

### 1. 启动后端服务
```bash
cd im-backend
go run cmd/server/main.go
```

### 2. 启动前端服务
```bash
cd im-frontend
npm run dev
```

### 3. 确保数据库运行
- PostgreSQL 或 MySQL 数据库已启动
- Redis 服务已启动

## 🧪 测试流程

### 阶段 1: 用户注册和登录

1. **创建测试用户**
   - 访问 `http://localhost:3000/login`
   - 注册至少 3 个测试用户：
     - 用户A（群主）
     - 用户B（管理员）
     - 用户C（普通成员）

2. **建立好友关系**
   - 用户A 添加用户B和用户C为好友
   - 确保好友请求被接受

### 阶段 2: 群组管理测试

#### 2.1 创建群组
1. 使用用户A登录
2. 访问 `/groups` 页面
3. 点击"创建群聊"按钮
4. 填写群组信息：
   - 群组名称：`测试群聊`
   - 群组描述：`这是一个测试群组`
   - 最大成员数：`100`
   - 设置为公开群组
5. 点击创建

**预期结果：**
- ✅ 群组创建成功
- ✅ 用户A自动成为群主
- ✅ 群组出现在"我的群组"列表中

#### 2.2 邀请成员加入
1. 记录群组ID
2. 使用用户B登录
3. 在群组搜索中输入群组ID或名称
4. 点击"加入"按钮

**预期结果：**
- ✅ 用户B成功加入群组
- ✅ 群成员数量更新
- ✅ 用户B在群成员列表中显示

#### 2.3 设置管理员
1. 使用用户A（群主）登录
2. 进入群组详情页面
3. 在成员列表中找到用户B
4. 设置用户B为管理员

**预期结果：**
- ✅ 用户B角色更新为管理员
- ✅ 用户B获得管理员权限

### 阶段 3: 群聊消息测试

#### 3.1 发送群消息
1. 使用用户A登录
2. 访问 `/chat` 页面
3. 在聊天列表中选择创建的群组
4. 发送测试消息：`大家好，这是第一条群消息！`

**预期结果：**
- ✅ 消息成功发送
- ✅ 消息显示在群聊界面
- ✅ 消息显示发送者信息

#### 3.2 实时消息接收
1. 保持用户A在群聊界面
2. 使用用户B登录（新浏览器窗口）
3. 用户B进入同一个群聊
4. 用户B发送消息：`收到！我是用户B`

**预期结果：**
- ✅ 用户A实时收到用户B的消息
- ✅ 消息显示正确的发送者头像和昵称
- ✅ WebSocket连接正常工作

#### 3.3 未读消息计数
1. 用户A退出群聊界面
2. 用户B继续发送几条消息
3. 用户A重新进入聊天页面

**预期结果：**
- ✅ 群聊显示未读消息数量
- ✅ 进入群聊后未读数清零
- ✅ 总未读数正确更新

### 阶段 4: 权限管理测试

#### 4.1 踢出成员
1. 添加用户C到群组
2. 使用用户B（管理员）登录
3. 在群成员管理中踢出用户C

**预期结果：**
- ✅ 用户C被成功踢出
- ✅ 群成员数量减少
- ✅ 用户C无法再访问群聊

#### 4.2 权限验证
1. 使用普通成员账号尝试踢出其他成员
2. 尝试修改群组信息

**预期结果：**
- ✅ 操作被拒绝
- ✅ 显示权限不足错误

### 阶段 5: 消息功能测试

#### 5.1 消息撤回
1. 发送一条消息
2. 在2分钟内撤回消息

**预期结果：**
- ✅ 消息成功撤回
- ✅ 其他用户看到撤回提示

#### 5.2 @功能测试
1. 发送包含@其他用户的消息
2. 验证@功能是否正常工作

**预期结果：**
- ✅ @功能正常
- ✅ 被@用户收到特殊通知

## 🔧 API 测试

### 使用 curl 测试后端 API

#### 1. 创建群组
```bash
curl -X POST http://localhost:8080/api/v1/groups/create \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "API测试群",
    "description": "通过API创建的测试群",
    "max_members": 50,
    "is_public": true,
    "join_approval": false
  }'
```

#### 2. 获取群组列表
```bash
curl -X GET http://localhost:8080/api/v1/groups/my-list \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 3. 发送群消息
```bash
curl -X POST http://localhost:8080/api/v1/groups/messages/send \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "group_id": "GROUP_ID",
    "message_type": 1,
    "content": "API测试消息"
  }'
```

## ✅ 测试检查清单

### 基础功能
- [ ] 用户注册和登录
- [ ] 好友关系建立
- [ ] 群组创建
- [ ] 群组搜索和加入
- [ ] 群成员管理

### 消息功能
- [ ] 发送群消息
- [ ] 实时消息接收
- [ ] 未读消息计数
- [ ] 消息撤回
- [ ] @功能

### 权限管理
- [ ] 群主权限
- [ ] 管理员权限
- [ ] 普通成员权限
- [ ] 权限验证

### 界面功能
- [ ] 群聊列表显示
- [ ] 群组详情页面
- [ ] 成员列表
- [ ] 聊天界面
- [ ] 错误处理

### WebSocket 功能
- [ ] 连接建立
- [ ] 消息推送
- [ ] 断线重连
- [ ] 心跳机制

## 🐛 常见问题排查

### 1. WebSocket 连接失败
- 检查后端 WebSocket 服务是否启动
- 验证 token 是否有效
- 检查网络连接

### 2. 消息发送失败
- 验证用户是否为群成员
- 检查用户是否被禁言
- 确认群组是否存在

### 3. 权限错误
- 验证用户角色
- 检查操作权限
- 确认目标用户状态

### 4. 数据库错误
- 检查数据库连接
- 验证表结构是否正确
- 查看数据库日志

## 📊 性能测试

### 1. 并发消息测试
- 多个用户同时发送消息
- 验证消息顺序和完整性

### 2. 大群组测试
- 创建包含大量成员的群组
- 测试消息推送性能

### 3. 长时间连接测试
- 保持 WebSocket 连接数小时
- 验证连接稳定性

## 🎉 测试完成

完成所有测试项目后，群聊功能应该能够：

1. ✅ 稳定运行
2. ✅ 正确处理各种用户操作
3. ✅ 实时推送消息
4. ✅ 正确管理权限
5. ✅ 优雅处理错误

恭喜！群聊功能已经可以投入使用了！🎊